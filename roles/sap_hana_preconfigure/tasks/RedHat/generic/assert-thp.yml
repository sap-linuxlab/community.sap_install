# SPDX-License-Identifier: Apache-2.0
---

# can be configured by tuned profile sap-hana, entry "transparent_hugepages=never" or "transparent_hugepages=madvise"
- name: Assert correct setting of THP
  when: not sap_hana_preconfigure_use_tuned or
        sap_hana_preconfigure_modify_grub_cmdline_linux or
        sap_hana_preconfigure_assert_all_config | d(false)
  block:

    - name: THP - Get contents of GRUB_CMDLINE_LINUX in /etc/default/grub
      ansible.builtin.command: grep GRUB_CMDLINE_LINUX /etc/default/grub
      register: __sap_hana_preconfigure_register_default_grub_cmdline_thp_assert
      changed_when: false

    - name: THP - Get contents of /proc/cmdline
      ansible.builtin.command: cat /proc/cmdline
      register: __sap_hana_preconfigure_register_proc_cmdline_thp_assert
      changed_when: false

    - name: THP - Get current status of THP
      ansible.builtin.command: cat /sys/kernel/mm/transparent_hugepage/enabled
      register: __sap_hana_preconfigure_register_sys_kernel_thp_assert
      changed_when: false

    - name: Set fact for THP, RHEL up to RHEL 9.1
      ansible.builtin.set_fact:
        __sap_hana_preconfigure_fact_thp: 'never'
        __sap_hana_preconfigure_fact_thp_boot_command_line_arg: "transparent_hugepage=never"
      when:
        - sap_hana_preconfigure_thp is undefined or sap_hana_preconfigure_thp | length == 0
        - ansible_distribution_major_version == '7' or
          ansible_distribution_major_version == '8' or
          ansible_distribution_version == '9.0' or
          ansible_distribution_version == '9.1'

    - name: Set fact for THP, RHEL 9.2 and later
      ansible.builtin.set_fact:
        __sap_hana_preconfigure_fact_thp: 'madvise'
        __sap_hana_preconfigure_fact_thp_boot_command_line_arg: "transparent_hugepage=madvise"
      when:
        - sap_hana_preconfigure_thp is undefined or sap_hana_preconfigure_thp | length == 0
        - ansible_distribution_major_version | int >= 10 or
          (ansible_distribution_major_version == '9' and
            __sap_hana_preconfigure_fact_ansible_distribution_minor_version | int >= 2)

    # TODO: Replace with full validations for accepted values ['always', 'madvise', 'never']
    # and implement block for followup tasks.
    - name: Set fact for THP if 'sap_hana_preconfigure_thp' is defined
      ansible.builtin.set_fact:
        __sap_hana_preconfigure_fact_thp: "{{ sap_hana_preconfigure_thp }}"
        __sap_hana_preconfigure_fact_thp_boot_command_line_arg: "transparent_hugepage={{ sap_hana_preconfigure_thp }}"
        __sap_hana_preconfigure_fact_thp_fail_msg_grub: "FAIL: 'transparent_hugepage={{ sap_hana_preconfigure_thp }}' is not in GRUB_CMDLINE_LINUX in /etc/default/grub!"
        __sap_hana_preconfigure_fact_thp_success_msg_grub: "PASS: 'transparent_hugepage={{ sap_hana_preconfigure_thp }}' is in GRUB_CMDLINE_LINUX in /etc/default/grub."
        __sap_hana_preconfigure_fact_thp_fail_msg_proc_cmdline: "FAIL: 'transparent_hugepage={{ sap_hana_preconfigure_thp }}' is not in /proc/cmdline!"
        __sap_hana_preconfigure_fact_thp_success_msg_proc_cmdline: "PASS: 'transparent_hugepage={{ sap_hana_preconfigure_thp }}' is in /proc/cmdline."
        __sap_hana_preconfigure_fact_thp_fail_msg_cur: "FAIL: THP is currently configured with the status of '{{ __sap_hana_preconfigure_register_sys_kernel_thp_assert.stdout.split('[')[1].split(']')[0] }}' but it needs to be '{{ __sap_hana_preconfigure_fact_thp }}'!"
        __sap_hana_preconfigure_fact_thp_success_msg_cur: "PASS: THP is currently configured with the correct status of '{{ __sap_hana_preconfigure_fact_thp }}'."
      when:
        - sap_hana_preconfigure_thp is defined
        - sap_hana_preconfigure_thp is string
        - sap_hana_preconfigure_thp | length > 0

    - name: Display __sap_hana_preconfigure_fact_thp_boot_command_line_arg
      ansible.builtin.debug:
        msg: "__sap_hana_preconfigure_fact_thp_boot_command_line_arg = >{{ __sap_hana_preconfigure_fact_thp_boot_command_line_arg }}"

    - name: Assert that 'transparent_hugepage={{ __sap_hana_preconfigure_fact_thp }}' is in GRUB_CMDLINE_LINUX in /etc/default/grub
      ansible.builtin.assert:
        that: __sap_hana_preconfigure_fact_thp_boot_command_line_arg in __sap_hana_preconfigure_register_default_grub_cmdline_thp_assert.stdout
        fail_msg: __sap_hana_preconfigure_fact_thp_fail_msg_grub
        success_msg: __sap_hana_preconfigure_fact_thp_success_msg_grub
      ignore_errors: "{{ sap_hana_preconfigure_assert_ignore_errors | d(false) }}"

    - name: Assert that 'transparent_hugepage={{ __sap_hana_preconfigure_fact_thp }}' is in /proc/cmdline
      ansible.builtin.assert:
        that: __sap_hana_preconfigure_fact_thp_boot_command_line_arg in __sap_hana_preconfigure_register_proc_cmdline_thp_assert.stdout
        fail_msg: __sap_hana_preconfigure_fact_thp_fail_msg_proc_cmdline
        success_msg: __sap_hana_preconfigure_fact_thp_success_msg_proc_cmdline
      ignore_errors: "{{ sap_hana_preconfigure_assert_ignore_errors | d(false) }}"

    - name: Assert that THP currently has the correct status
      ansible.builtin.assert:
        that: __sap_hana_preconfigure_register_sys_kernel_thp_assert.stdout.split('[')[1].split(']')[0] == '{{ __sap_hana_preconfigure_fact_thp }}'
        fail_msg: __sap_hana_preconfigure_fact_thp_fail_msg_cur
        success_msg: __sap_hana_preconfigure_fact_thp_success_msg_cur
      ignore_errors: "{{ sap_hana_preconfigure_assert_ignore_errors | d(false) }}"
