# SPDX-License-Identifier: Apache-2.0
---

################
# Prepare software path
################

# Software Path

- name: SAP SWPM Pre Install - Check availability of software path - {{ sap_swpm_software_path }}
  ansible.builtin.stat:
    path: "{{ sap_swpm_software_path }}"
  register: __sap_swpm_register_software_path

- name: SAP SWPM Pre Install - Fail if the software path does not exist
  ansible.builtin.fail:
    msg: "The software path at '{{ sap_swpm_software_path }}' does not exist!"
  when: not __sap_swpm_register_software_path.stat.exists

- name: SAP SWPM Pre Install - Set directory and file permissions
  when: sap_swpm_set_file_permissions
  block:

    - name: SAP SWPM Pre Install - Find directories
      ansible.builtin.find:
        path: "{{ sap_swpm_software_path }}"
        file_type: directory
      register: __sap_swpm_register_find_result_directories

    - name: SAP SWPM Pre Install - Create list of directories
      ansible.builtin.set_fact:
        __sap_swpm_fact_directories: "{{ __sap_swpm_register_find_result_directories.files | map(attribute='path') | reject('contains', 'extracted') }}"

    - name: SAP SWPM Pre Install - Ensure correct permissions and ownership of all directories
      ansible.builtin.file:
        path: "{{ line_item }}"
        recurse: no
        mode: "{{ sap_swpm_software_directory_mode }}"
        owner: "{{ sap_swpm_software_directory_owner }}"
        group: "{{ sap_swpm_software_directory_group }}"
      loop: "{{ __sap_swpm_fact_directories }}"
      loop_control:
        loop_var: line_item
      when:
        - __sap_swpm_fact_directories is defined
        - __sap_swpm_register_find_result_directories is defined

    - name: SAP SWPM Pre Install - Find non-SAPCAR files
      ansible.builtin.find:
        path: "{{ sap_swpm_software_path }}"
        file_type: file
        recurse: true
        excludes: "SAPCAR*EXE"
      register: __sap_swpm_register_find_result_files_non_sapcar

    - name: SAP SWPM Pre Install - Create list of files
      ansible.builtin.set_fact:
        __sap_swpm_fact_files_non_sapcar: "{{ __sap_swpm_register_find_result_files_non_sapcar.files | map(attribute='path') | reject('contains', 'extracted/') }}"
      when: __sap_swpm_register_find_result_files_non_sapcar is defined

# Reasons for noqa:
# - command-instead-of-module: Shorter execution time compared to looping over a list when using the file module
# - no-changed-when: Not worth checking permissions and ownership before this task and comparing afterwards
    - name: SAP SWPM Pre Install - Ensure correct permissions and ownership of all non-SAPCAR files # noqa command-instead-of-module no-changed-when
      ansible.builtin.shell: >
         chown {{ sap_swpm_files_non_sapcar_owner }}:{{ sap_swpm_files_non_sapcar_group }} \
         {{ line_item | join(' ') }} &&
         chmod {{ sap_swpm_files_non_sapcar_mode }} \
         {{ line_item | join(' ') }}
      loop: "{{ __sap_swpm_fact_files_non_sapcar | batch(100) }}"
      loop_control:
        loop_var: line_item
        label: "Batch {{ (__sap_swpm_fact_files_non_sapcar.index(line_item[0]) // 100) + 1 }}, first item: {{ line_item[0] }}"
      when:
        - __sap_swpm_fact_files_non_sapcar is defined
        - __sap_swpm_register_find_result_files_non_sapcar is defined


################
# Get software files from software paths
################

- name: SAP SWPM Pre Install - Prepare SAPCAR files
  ansible.builtin.include_tasks:
    file: software/sapcar.yml

- name: SAP SWPM Pre Install - Prepare SWPM files
  ansible.builtin.include_tasks:
    file: software/swpm.yml


- name: SAP SWPM Pre Install - Full SAP System
  when: not sap_swpm_generic
  block:

    - name: SAP SWPM Pre Install - Check IGS files
      ansible.builtin.include_tasks:
        file: software/igsexe.yml

    - name: SAP SWPM Pre Install - Check IGS Helper files
      ansible.builtin.include_tasks:
        file: software/igshelper.yml

    - name: SAP SWPM Pre Install - Check SAPEXEDB files
      ansible.builtin.include_tasks:
        file: software/sapexedb.yml

    - name: SAP SWPM Pre Install - Check SAPEXE files
      ansible.builtin.include_tasks:
        file: software/sapexe.yml


- name: SAP SWPM Pre Install - Check Webdispatcher files
  ansible.builtin.include_tasks:
    file: software/sapwebdisp.yml
  when: "'Webdispatcher' in sap_swpm_product_catalog_id | string"
