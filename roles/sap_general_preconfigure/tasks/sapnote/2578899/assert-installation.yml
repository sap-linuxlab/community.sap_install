# SPDX-License-Identifier: Apache-2.0
---

# Check rpm --whatprovides only if package cannot be found directly.
- name: Query RPM packages
  ansible.builtin.shell:
    cmd: |
      if rpm -q {{ package_item }} &> /dev/null;
      then rpm -q {{ package_item }}
      else rpm -q --whatprovides {{ package_item }};
      fi
  register: __sap_general_preconfigure_register_packages
  loop: "{{ __sap_general_preconfigure_packages_2578899 }}"
  loop_control:
    loop_var: package_item
  changed_when: false
  ignore_errors: true

- name: Assert that all required packages are installed
  ansible.builtin.assert:
    that: __sap_general_preconfigure_register_packages.results | selectattr('package_item', 'equalto', package_item) | map(attribute='rc') | first == 0
    fail_msg: "FAIL: Package '{{ package_item }}' is not installed!"
    success_msg: "PASS: Package '{{ package_item }}' is installed."
  loop: "{{ __sap_general_preconfigure_packages_2578899 }}"
  loop_control:
    loop_var: package_item
  ignore_errors: "{{ sap_general_preconfigure_assert_ignore_errors | d(false) }}"
