# SPDX-License-Identifier: Apache-2.0
---
# This file is executed only if we detected addhosts that are not present yet.
# We need to create new updated addhosts string after removing existing hosts.
# New addhosts string has to be injected into configfile,
# because we cannot override user set 'sap_hana_install_addhosts' due to precedence.

- name: SAP HANA - Addhosts - Set fact for updated addhosts string
  ansible.builtin.set_fact:
    __sap_hana_install_fact_addhosts: "{{ __sap_hana_install_fact_addhosts | d([]) + [item] }}"
  loop: "{{ sap_hana_install_addhosts.split(',') | map('trim') | reject('equalto', '') | list }}"
  when: item.split(':')[0] in __sap_hana_install_fact_addhosts_hosts_new
  tags: sap_hana_install_create_configfile

- name: SAP HANA - Addhosts - Update configfile with new addhosts string
  ansible.builtin.lineinfile:
    path: "{{ __sap_hana_install_register_tmpdir.path }}/configfile.cfg"
    regexp: '^addhosts\s*=\s*.*$'
    line: "addhosts = {{ __sap_hana_install_fact_addhosts | join(',') }}"
  tags: sap_hana_install_create_configfile


- name: SAP HANA - Addhosts - Set fact for hdblcm command line
  ansible.builtin.set_fact:
    __sap_hana_install_hdblcm_command: >-
      ./hdblcm {{ sap_hana_install_hdblcm_extraargs | d('') }}
        --action=add_hosts
        --password={{ sap_hana_install_sidadm_password | d(sap_hana_install_master_password) }}
        {% if __sap_hana_install_fact_is_lss_required %}
        --lss_user_password={{ sap_hana_install_lss_user_password | d(sap_hana_install_master_password) }}
        {% endif %}
        --configfile={{ __sap_hana_install_register_tmpdir.path }}/configfile.cfg
        -b
  tags: sap_hana_install_hdblcm_commandline

- name: SAP HANA - Addhosts - Show the hdblcm addhosts command line
  ansible.builtin.debug:
    msg: >-
      SAP HANA addhosts command:
      ./hdblcm {{ sap_hana_install_hdblcm_extraargs | d('') }}
        --action=add_hosts
        --password=<PASSWORD_HIDDEN>
        {% if __sap_hana_install_fact_is_lss_required %}
        --lss_user_password=<PASSWORD_HIDDEN>
        {% endif %}
        --configfile={{ __sap_hana_install_register_tmpdir.path }}/configfile.cfg
        -b
  tags: sap_hana_install_hdblcm_commandline

- name: SAP HANA - Addhosts - Add hosts to the existing SAP HANA installation
  ansible.builtin.command:
    cmd: "{{ __sap_hana_install_hdblcm_command }}"
  register: __sap_hana_install_register_hdblcm_add_hosts
  args:
    chdir: "{{ sap_hana_install_shared_path }}/{{ sap_hana_install_sid }}/hdblcm"
  changed_when: "'SAP HANA Lifecycle Management' in __sap_hana_install_register_hdblcm_add_hosts.stdout"
  when: not ansible_check_mode

- name: SAP HANA - Addhosts - Show the result of hdblcm add_hosts
  ansible.builtin.debug:
    msg: "{{ __sap_hana_install_register_hdblcm_add_hosts.stdout }}"
  when:
    - not ansible_check_mode
    - __sap_hana_install_register_hdblcm_add_hosts.stdout is defined
