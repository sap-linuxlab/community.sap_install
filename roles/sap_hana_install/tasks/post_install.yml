# SPDX-License-Identifier: Apache-2.0
---

# Installation tasks that can be destructive and should never be executed on existing database.
- name: Block with tasks for new HANA Systems
  when:
    - not __sap_hana_install_fact_is_installed | d(false)
  block:

    - name: SAP HANA Post Install - Store connection information
      ansible.builtin.include_tasks:
        file: post_install/hdbuserstore.yml
      tags: sap_hana_install_store_connection_information

    - name: SAP HANA Post Install - Set log_mode
      ansible.builtin.include_tasks:
        file: post_install/log_mode.yml
      tags: sap_hana_install_set_log_mode

    - name: SAP HANA Post Install - Apply license
      ansible.builtin.include_tasks:
        file: post_install/license.yml
      when: sap_hana_install_apply_license

    - name: SAP HANA Post Install - Recreate the initial tenant database
      ansible.builtin.include_tasks:
        file: post_install/recreate_tenant_database.yml
      when: sap_hana_install_recreate_tenant_database | d(true)

    - name: SAP HANA Post Install - Perform an hdblcm installation check
      ansible.builtin.include_tasks:
        file: post_install/check_installation.yml
      when: sap_hana_install_check_installation | d(false)
      tags: sap_hana_install_check_installation

    - name: SAP HANA Post Install - Generate Input File for SAP Application Deployment
        '{{ sap_hana_install_nw_input_location }}/{{ sap_hana_install_sid }}.info.nw.install'
      ansible.builtin.template:
        src: "{{ role_path }}/templates/sap-nw-input.j2"
        dest: "{{ sap_hana_install_nw_input_location }}/{{ sap_hana_install_sid }}.info.nw.install"
        mode: '0600'
      become: false
      delegate_to: localhost
      vars:
        ansible_become: false
      tags: sap_hana_install_generate_input_file

    # Cleanup extracted software
    - name: SAP HANA Post Install - Deleting software extract directory '{{ sap_hana_install_software_extract_directory }}'
      ansible.builtin.file:
        path: "{{ sap_hana_install_software_extract_directory }}"
        state: absent
      when: sap_hana_install_cleanup_extract_directory

    - name: SAP HANA Post Install - Deleting Configfile Directory '{{ sap_hana_install_configfile_directory }}'
      ansible.builtin.file:
        path: "{{ sap_hana_install_configfile_directory }}"
        state: absent
      when: sap_hana_install_cleanup_configfile_directory


# Idempotent tasks for new and existing HANA Systems
- name: SAP HANA Post Install - Set '{{ sap_hana_install_sid | lower }}adm' to not expire
  ansible.builtin.shell: |
      chage -m 0 -M 99999 -I -1 -E -1 {{ sap_hana_install_sid | lower }}adm
  args:
    executable: /bin/bash
  become: true
  register: __sap_hana_install_post_install_register_sidadm_noexpire
  changed_when: __sap_hana_install_post_install_register_sidadm_noexpire.rc == 0
  when: sap_hana_install_set_sidadm_noexpire | default(true)

- name: SAP HANA Post Install - Firewall
  ansible.builtin.include_tasks:
    file: post_install/firewall.yml
  when: sap_hana_install_update_firewall
  tags: sap_hana_install_configure_firewall

- name: SAP HANA Post Install - SELinux
  ansible.builtin.include_role:
    name: '{{ sap_hana_install_system_roles_collection }}.selinux'
  vars:
    selinux_fcontexts:
      - { target: '/usr/sap(/.*)?', setype: 'usr_t' }
    selinux_restore_dirs:
      - /usr/sap
  when: sap_hana_install_modify_selinux_labels

- name: SAP HANA Post Install - Fapolicyd
  ansible.builtin.include_tasks:
    file: post_install/fapolicyd.yml
  when:
    # Ensure fapolicyd is checked only on supported systems.
    - ansible_os_family == "RedHat"
    - sap_hana_install_use_fapolicyd
    - '"fapolicyd" in ansible_facts.packages'
  tags: sap_hana_install_use_fapolicyd


# Gather details about installed database for finished message
- name: SAP HANA Install - Run 'hdblcm --list_systems' after the installation
  ansible.builtin.shell: |
      set -o pipefail && ./hdblcm --list_systems | awk '/\/hana\/shared\/{{ sap_hana_install_sid }}/{a=1}
      /version:/{if (a==1){
        gsub ("^\\s*version: ", "");printf ("%s;", $NF)}
      }
      /hosts?:/{if (a==1){
        gsub ("^\\s*hosts?: ", ""); gsub (", ", ","); print; a=0}
      }'
  args:
    chdir: "{{ sap_hana_install_shared_path }}/{{ sap_hana_install_sid }}/hdblcm"
  register: __sap_hana_install_register_install_result
  changed_when: false
  when: not ansible_check_mode

- name: SAP HANA Post Install - Set facts with HANA version and hosts
  ansible.builtin.set_fact:
    __sap_hana_install_fact_hana_version: "{{ __sap_hana_install_register_install_result.stdout.split(';')[0] }}"
    __sap_hana_install_fact_hana_hosts: "{{ __sap_hana_install_register_install_result.stdout.split(';')[1] }}"
  when: not ansible_check_mode


- name: SAP HANA Post Install - New installation was finished
  ansible.builtin.debug:
    msg: |
      SAP HANA deployment successfully completed:
      HANA Version     -       {{ __sap_hana_install_fact_hana_version }}
      Hosts            -       {{ __sap_hana_install_fact_hana_hosts }}
      SID              -       {{ sap_hana_install_sid }}
      NR               -       {{ sap_hana_install_number }}
#      IP               -       {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}
#      Host             -       {{ ansible_hostname }}
#      FQDN             -       {{ ansible_fqdn }}
  when:
    - not __sap_hana_install_fact_is_installed | d(false)
    - not ansible_check_mode

- name: SAP HANA Post Install - Configuration steps completed
  ansible.builtin.debug:
    msg: |
      SAP HANA configuration steps were completed:
      - Set user '{{ sap_hana_install_sid | lower }}adm' to not expire
      {% if sap_hana_install_update_firewall %}
      - Enable firewall and open SAP HANA ports
      {% endif %}
      {% if sap_hana_install_modify_selinux_labels %}
      - SElinux policies updated for SAP folders /usr/sap/
      {% endif %}
      {% if ansible_os_family == "RedHat" and sap_hana_install_use_fapolicyd and "fapolicyd" in ansible_facts.packages %}
      - Fapolicyd configuration was updated
      {% endif %}
  when: not ansible_check_mode
