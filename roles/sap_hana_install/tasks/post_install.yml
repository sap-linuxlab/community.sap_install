# SPDX-License-Identifier: Apache-2.0
---

# Installation tasks that can be destructive and should never be executed on existing database.
- name: Block with tasks for new HANA Systems
  when: >
    (not __sap_hana_install_fact_is_installed and __sap_hana_install_fact_is_main_host) or
    ('sap_hana_install_check_installation' in ansible_run_tags|d([]))
  block:

    - name: SAP HANA - Install - Post-Tasks - Set log_mode
      ansible.builtin.include_tasks:
        file: post_tasks/log_mode.yml

    - name: SAP HANA - Install - Post-Tasks - Apply license
      ansible.builtin.include_tasks:
        file: post_tasks/license.yml
      when: sap_hana_install_apply_license

    - name: SAP HANA - Install - Post-Tasks - Recreate the initial tenant database
      ansible.builtin.include_tasks:
        file: post_tasks/recreate_tenant_database.yml
      when: sap_hana_install_recreate_tenant_database | d(true)

    - name: SAP HANA - Install - Post-Tasks - Perform an hdblcm installation check
      ansible.builtin.include_tasks:
        file: post_tasks/check_installation.yml
        apply:
          tags: sap_hana_install_check_installation
      when: sap_hana_install_check_installation or ('sap_hana_install_check_installation' in ansible_run_tags|d([]))
      tags: sap_hana_install_check_installation

    - name: SAP HANA - Install - Post-Tasks - Generate Input File for SAP Application Deployment
        '{{ sap_hana_install_nw_input_location }}/{{ sap_hana_install_sid }}.info.nw.install'
      ansible.builtin.template:
        src: "{{ role_path }}/templates/sap-nw-input.j2"
        dest: "{{ sap_hana_install_nw_input_location }}/{{ sap_hana_install_sid }}.info.nw.install"
        mode: '0600'
      become: false
      delegate_to: localhost
      vars:
        ansible_become: false

    # Cleanup extracted software
    - name: SAP HANA - Install - Post-Tasks - Deleting software extract directory '{{ sap_hana_install_software_extract_directory }}'
      ansible.builtin.file:
        path: "{{ sap_hana_install_software_extract_directory }}"
        state: absent
      when: sap_hana_install_cleanup_extract_directory

    - name: SAP HANA - Install - Post-Tasks - Deleting Configfile Directory '{{ sap_hana_install_configfile_directory }}'
      ansible.builtin.file:
        path: "{{ sap_hana_install_configfile_directory }}"
        state: absent
      when: sap_hana_install_cleanup_configfile_directory


# Execute on all hosts in play to achieve idempotency.
- name: SAP HANA - Addhosts - Post-Tasks - Set user expiration
  ansible.builtin.include_tasks:
    file: post_tasks/user_expiration.yml
  when:
    - sap_hana_install_set_sidadm_noexpire | d(true)

- name: SAP HANA - Install - Post-Tasks - Update hdbuserstore connection details
  ansible.builtin.include_tasks:
    file: post_tasks/hdbuserstore.yml

- name: SAP HANA - Install - Post-Tasks - Firewall
  ansible.builtin.include_tasks:
    file: post_tasks/firewall.yml
  when: sap_hana_install_update_firewall

- name: SAP HANA - Install - Post-Tasks - SELinux
  ansible.builtin.include_tasks:
    file: post_tasks/selinux.yml
  when: __sap_hana_install_configure_selinux

- name: SAP HANA - Install - Post-Tasks - Fapolicyd
  ansible.builtin.include_tasks:
    file: post_tasks/fapolicyd.yml
  when:
    # Ensure fapolicyd is checked only on supported systems.
    - ansible_os_family == "RedHat"
    - __sap_hana_install_configure_fapolicyd
