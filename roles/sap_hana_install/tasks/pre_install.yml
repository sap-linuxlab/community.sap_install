# SPDX-License-Identifier: Apache-2.0
---

- name: SAP HANA - Install - Pre-Tasks - Install and disable fapolicyd
  ansible.builtin.include_tasks:
    file: pre_tasks/fapolicyd.yml
  when:
    # Ensure fapolicyd is checked only on supported systems.
    - ansible_os_family == "RedHat"
    - not __sap_hana_install_fact_is_installed
  tags: sap_hana_install_configure_fapolicyd


- name: SAP HANA - Install - Pre-Tasks - Configure SELinux file contexts for {{ sap_hana_install_root_path }}
  ansible.builtin.include_tasks:
    file: pre_tasks/selinux.yml
  when:
    - __sap_hana_install_configure_selinux
    - not __sap_hana_install_fact_is_installed


# This task will run on existing system because we need to validate version from manifest file.
- name: SAP HANA - Install - Pre-Tasks - Validate and prepare software directory
  ansible.builtin.include_tasks:
    file: pre_tasks/prepare_software_install.yml
  when: __sap_hana_install_fact_is_main_host


# Proper idempotency needs to check existing version, not just existence.
- name: SAP HANA - Install - Pre-Tasks - Validate existing HANA version
  ansible.builtin.include_tasks:
    file: pre_tasks/check_version.yml
  when: __sap_hana_install_fact_is_main_host

- name: SAP HANA - Install - Pre-Tasks - Check shared filesystems
  ansible.builtin.include_tasks:
    file: pre_tasks/check_filesystems.yml
  when: __sap_hana_install_fact_is_scaleout


# We need to change permissions only after filesystem check has passed.
- name: SAP HANA - Install - Pre-Tasks - Change ownership of HANA directories
  ansible.builtin.include_tasks:
    file: pre_tasks/hana_directory_permissions.yml
  # Execute only once for Scale-Out to avoid conflicts when updating shared file systems.
  run_once: "{{ __sap_hana_install_fact_is_scaleout }}"
  when: not __sap_hana_install_fact_is_installed
  tags: sap_hana_install_chown_hana_directories

- name: SAP HANA - Install - Pre-Tasks - Process the hdblcm configfile
  ansible.builtin.include_tasks:
    file: pre_tasks/hdblcm_configfile.yml
  when:
    - __sap_hana_install_fact_is_main_host
    - not __sap_hana_install_fact_is_installed
