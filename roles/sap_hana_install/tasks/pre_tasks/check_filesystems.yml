# SPDX-License-Identifier: Apache-2.0
---

# We need to ensure that Scale-Out system has filesystems shared to avoid failure in hdblcm.
# We cannot fully test with 'touch' as it can be blocked by SElinux or Fapolicyd.

# NOTE: We cannot validate shared filesystems for Scale-Up!

- name: SAP HANA - Install - Pre-Tasks - Gather mount facts
  ansible.builtin.setup:
    filter: ansible_mounts

# /hana/shared
- name: SAP HANA - Install - Pre-Tasks - Set fact with mount details of {{ sap_hana_install_shared_path }}
  ansible.builtin.set_fact:
    __sap_hana_install_fact_mount_hana_shared:
      "{{ ansible_mounts | selectattr('mount', 'equalto', sap_hana_install_shared_path) | list | first }}"
  when: ansible_mounts | selectattr('mount', 'equalto', sap_hana_install_shared_path) | list | length > 0

- name: SAP HANA - Install - Pre-Tasks - Assert that filesystem is shared - {{ sap_hana_install_shared_path }}
  ansible.builtin.assert:
    that:
      - __sap_hana_install_fact_mount_hana_shared is defined
      - __sap_hana_install_fact_mount_hana_shared.fstype is defined
      - __sap_hana_install_fact_mount_hana_shared.fstype in __sap_hana_install_shared_filesystem_types
    success_msg: >-
      PASS: The directory {{ sap_hana_install_shared_path }} is mounted as one of supported
      filesystem types {{ __sap_hana_install_shared_filesystem_types | join(', ') }}.
    fail_msg: |
      FAIL: The directory {{ sap_hana_install_shared_path }} is not mounted as shared filesystem.
      This is required for SAP HANA Scale-Out systems.

      Please ensure this is a correctly mounted shared filesystem before proceeding.
      This role validates prerequisites but does not configure system mounts.

      {% if __sap_hana_install_fact_mount_hana_shared.fstype is defined %}
      Detected filesystem type: {{ __sap_hana_install_fact_mount_hana_shared.fstype }}
      {% endif %}
      Supported filesystem types: {{ __sap_hana_install_shared_filesystem_types | join(', ') }}


# /lss/shared - Required for SAP HANA 2.0 SPS08 and higher.
- name: Block to run if revision version was gathered.
  when:
    - hostvars[__sap_hana_install_fact_main_host]['__sap_hana_install_fact_is_lss_required'] is defined
    - hostvars[__sap_hana_install_fact_main_host]['__sap_hana_install_fact_is_lss_required']
  block:
    - name: SAP HANA - Install - Pre-Tasks - Set fact for 'lss_inst_path'
      ansible.builtin.set_fact:
        __sap_hana_install_lss_inst_path: "{{ sap_hana_install_lss_inst_path }}"
      when:
        - sap_hana_install_lss_inst_path is defined
        - sap_hana_install_lss_inst_path is string
        - sap_hana_install_lss_inst_path | trim | length > 0

    - name: SAP HANA - Install - Pre-Tasks - Set fact with mount details of {{ __sap_hana_install_lss_inst_path }}
      ansible.builtin.set_fact:
        __sap_hana_install_fact_mount_lss_shared:
          "{{ ansible_mounts | selectattr('mount', 'equalto', __sap_hana_install_lss_inst_path) | list | first }}"
      when: ansible_mounts | selectattr('mount', 'equalto', __sap_hana_install_lss_inst_path) | list | length > 0

    - name: SAP HANA - Install - Pre-Tasks - Assert that filesystem is shared - {{ __sap_hana_install_lss_inst_path }}
      ansible.builtin.assert:
        that:
          - __sap_hana_install_fact_mount_lss_shared is defined
          - __sap_hana_install_fact_mount_lss_shared.fstype is defined
          - __sap_hana_install_fact_mount_lss_shared.fstype in __sap_hana_install_shared_filesystem_types
        success_msg: >-
          PASS: The directory {{ __sap_hana_install_lss_inst_path }} is mounted as one of supported
          filesystem types {{ __sap_hana_install_shared_filesystem_types | join(', ') }}.
        fail_msg: |
          FAIL: Directory {{ __sap_hana_install_lss_inst_path }} is not mounted as shared filesystem.
          This is required for SAP HANA 2.0 SPS08 and higher.

          Please ensure this is a correctly mounted shared filesystem before proceeding.
          This role validates prerequisites but does not configure system mounts.

          {% if __sap_hana_install_fact_mount_lss_shared.fstype is defined %}
          Detected filesystem type: {{ __sap_hana_install_fact_mount_lss_shared.fstype }}
          {% endif %}
          Supported filesystem types: {{ __sap_hana_install_shared_filesystem_types | join(', ') }}
