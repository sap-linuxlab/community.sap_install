# SPDX-License-Identifier: Apache-2.0
---
# hdblcm prepare

# Create directory {{ sap_hana_install_software_extract_directory }}
# This is where all extracted .SAR files will be stored

- name: SAP HANA - Pre-Tasks - Remove directory '{{ sap_hana_install_software_extract_directory }}'
  ansible.builtin.file:
    path: "{{ sap_hana_install_software_extract_directory }}"
    state: absent
  tags:
    - sap_hana_install_prepare_sapcar
    - sap_hana_install_prepare_sarfiles

- name: SAP HANA - Pre-Tasks - Create directory '{{ sap_hana_install_software_extract_directory }}'
  ansible.builtin.file:
    path: "{{ sap_hana_install_software_extract_directory }}"
    state: directory
    mode: '0755'
  tags:
    - sap_hana_install_prepare_sapcar
    - sap_hana_install_prepare_sarfiles

- name: SAP HANA - Pre-Tasks - Create SAPCAR directory '{{ sap_hana_install_software_extract_directory }}/sapcar'
  ansible.builtin.file:
    path: "{{ sap_hana_install_software_extract_directory }}/sapcar"
    state: directory
    mode: '0755'
  tags:
    - sap_hana_install_prepare_sapcar
    - sap_hana_install_prepare_sarfiles

- name: SAP HANA - Pre-Tasks - Create status file '{{ sap_hana_install_software_extract_directory }}/__EXTRACTION_ONGOING__'
  ansible.builtin.file:
    path: "{{ sap_hana_install_software_extract_directory }}/__EXTRACTION_ONGOING__"
    state: touch
    mode: '0755'

# Ensure that temporary file __EXTRACTION_ONGOING__ is removed if fail occurs.
- name: Rescue block for SAPCAR and SAR file preparation
  block:
    - name: SAP HANA - Pre-Tasks - Prepare SAPCAR
      ansible.builtin.include_tasks: prepare_sapcar.yml
      tags:
        - sap_hana_install_prepare_sapcar
        - sap_hana_install_prepare_sarfiles

    - name: SAP HANA - Pre-Tasks - Prepare SAR files
      ansible.builtin.include_tasks: prepare_sarfiles.yml
      tags: sap_hana_install_prepare_sarfiles
  rescue:
    - name: SAP HANA - Pre-Tasks - Remove status file '{{ sap_hana_install_software_extract_directory }}/__EXTRACTION_ONGOING__'
      ansible.builtin.file:
        path: "{{ sap_hana_install_software_extract_directory }}/__EXTRACTION_ONGOING__"
        state: absent

    - name: SAP HANA - Pre-Tasks - Preparation tasks failed
      ansible.builtin.fail:
        msg: |
          Preparation steps failed. Please see details of failed task above.
          Cleanup of temporary files was completed.


- name: SAP HANA - Pre-Tasks - Remove status file '{{ sap_hana_install_software_extract_directory }}/__EXTRACTION_ONGOING__'
  ansible.builtin.file:
    path: "{{ sap_hana_install_software_extract_directory }}/__EXTRACTION_ONGOING__"
    state: absent

- name: SAP HANA - Pre-Tasks - Find 'SAP_HANA_DATABASE' in '{{ sap_hana_install_software_extract_directory }}'
  ansible.builtin.find:
    paths: "{{ sap_hana_install_software_extract_directory }}"
    recurse: true
    file_type: directory
    patterns: 'SAP_HANA_DATABASE'
  register: __sap_hana_install_register_find_directory_sap_hana_database

- name: SAP HANA - Pre-Tasks - Set fact for 'hdblcm' installer path
  ansible.builtin.set_fact:
    __sap_hana_install_fact_hdblcm_path:
      "{{ __sap_hana_install_register_find_directory_sap_hana_database.files[0].path }}"
  when: not ansible_check_mode
