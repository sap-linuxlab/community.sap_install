# SPDX-License-Identifier: Apache-2.0
---

# Get details of user 'sapadm' and group 'sapsys' on main host.
- name: Block to get OS user details from main host
  when: __sap_hana_install_fact_is_main_host
  block:
    - name: SAP HANA - Addhosts - Pre-Tasks - Get details of the 'sapsys' group
      ansible.builtin.getent:
        database: group
        key: sapsys
      failed_when: false

    - name: SAP HANA - Addhosts - Pre-Tasks - Get info about user 'sapadm'
      ansible.builtin.getent:
        database: passwd
        key: sapadm
      failed_when: false

    # hana_exists already found existing database, this is additional check.
    # getent_group['sapsys'][1] and getent_passwd['sapadm'][2] are Group ID.
    - name: SAP HANA - Addhosts - Pre-Tasks - Assert that user 'sapadm' is present with group 'sapsys'
      ansible.builtin.assert:
        that:
          - "'sapsys' in getent_group"
          - "'sapadm' in getent_passwd"
          # Ensure sapadm user is assigned to sapsys group
          - getent_group['sapsys'][1] == getent_passwd['sapadm'][2]
        fail_msg: >-
          FAIL: User 'sapadm' with group 'sapsys' does not exist!

    # TODO: Issue#1123 Remove default to master
    - name: SAP HANA - Addhosts - Pre-Tasks - Generate password hash for 'sap_hana_install_sapadm_password'
      ansible.builtin.shell:
        cmd: "set -o pipefail && echo '{{ sap_hana_install_sapadm_password | d(sap_hana_install_master_password) }}' | openssl passwd -6 -stdin"
      register: __sap_hana_install_register_sapadm_password_hash
      no_log: true
      changed_when: false
      check_mode: false

- name: SAP HANA - Addhosts - Pre-Tasks - Create user 'sapadm' with group 'sapsys' on new hosts
  ansible.builtin.include_tasks:
    file: pre_tasks/create_users_groups.yml
  when: __sap_hana_install_fact_is_new_addhost_host


- name: SAP HANA - Addhosts - Pre-Tasks - Install and disable fapolicyd
  ansible.builtin.include_tasks:
    file: pre_tasks/fapolicyd.yml
  when:
    # Ensure fapolicyd is checked only on supported systems.
    - ansible_os_family == "RedHat"
    - __sap_hana_install_fact_is_new_addhost_host
  tags: sap_hana_install_configure_fapolicyd


- name: SAP HANA - Addhosts - Pre-Tasks - Configure SELinux file contexts for {{ sap_hana_install_root_path }}
  ansible.builtin.include_tasks:
    file: pre_tasks/selinux.yml
  when:
    - __sap_hana_install_configure_selinux
    - __sap_hana_install_fact_is_new_addhost_host


- name: SAP HANA - Addhosts - Pre-Tasks - Validate and prepare software directory
  ansible.builtin.include_tasks:
    file: pre_tasks/prepare_software_addhosts.yml
  when: __sap_hana_install_fact_is_main_host


# Proper idempotency needs to check existing version, not just existence.
- name: SAP HANA - Addhosts - Pre-Tasks - Validate existing HANA version
  ansible.builtin.include_tasks:
    file: pre_tasks/check_version.yml
  when: __sap_hana_install_fact_is_main_host

- name: SAP HANA - Addhosts - Pre-Tasks - Check shared filesystems
  ansible.builtin.include_tasks:
    file: pre_tasks/check_filesystems.yml


# Update HANA directory permissions
- name: SAP HANA - Addhosts - Pre-Tasks - Change ownership of HANA directories
  ansible.builtin.include_tasks:
    file: pre_tasks/hana_directory_permissions.yml
  # Execute only once for Scale-Out to avoid conflicts when updating shared file systems.
  when: __sap_hana_install_fact_is_main_host
  tags: sap_hana_install_chown_hana_directories

- name: SAP HANA - Addhosts - Pre-Tasks - Process the hdblcm configfile
  ansible.builtin.include_tasks:
    file: pre_tasks/hdblcm_configfile.yml
  when: __sap_hana_install_fact_is_main_host
