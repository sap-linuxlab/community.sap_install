# SPDX-License-Identifier: Apache-2.0
---

# Fail when more than one tag is used
- name: SAP HANA - Main - Fail if more than one tag is used
  ansible.builtin.fail:
    msg: "This role supports only one tag at a time."
  when: ansible_run_tags | d([]) | count > 1
  tags: always

# SAP HANA
- name: SAP HANA - Main - Prepare some variables
  ansible.builtin.include_tasks:
    file: pre_tasks/prepare_variables.yml
    apply:
      tags: always
  tags: always

# SAP HANA presence has to be validated for both new system and adding new hosts.
- name: SAP HANA - Main - Validate presence of existing SAP HANA database
  ansible.builtin.include_tasks:
    file: pre_tasks/hana_exists.yml
    apply:
      tags:
        - sap_hana_install_check_hana_exists
  when:
    - (sap_hana_install_new_system and not sap_hana_install_force)
      or not sap_hana_install_new_system
  tags:
    - sap_hana_install_check_hana_exists


- name: SAP HANA - Main - Identify hosts in play based on addhosts
  ansible.builtin.include_tasks:
    file: pre_tasks/identify_hosts.yml


- name: SAP HANA - Main - Ensure SAP HANA is running for existing systems or addhosts operations
  ansible.builtin.include_tasks:
    file: pre_tasks/hana_start.yml
  when:
    - __sap_hana_install_fact_is_installed
    - __sap_hana_install_fact_is_main_host


# Instructions for separating tasks to achieve idempotency:
# - Installation - Run once for new installations, never repeated.
# - Configuration - Run always to ensure idempotent outcome.

- name: Block for Installation tasks
  when: sap_hana_install_new_system or
    ('sap_hana_install_create_configfile' in ansible_run_tags | d([])) or
    ('sap_hana_install_hdblcm_commandline' in ansible_run_tags | d([]))
  block:
    - name: SAP HANA - Install - Pre-Tasks
      ansible.builtin.include_tasks:
        file: pre_install.yml
      tags:
        - sap_hana_install_create_configfile
        - sap_hana_install_hdblcm_commandline

    - name: SAP HANA - Install
      ansible.builtin.include_tasks:
        file: hana_install.yml
      when: >
        (not __sap_hana_install_fact_is_installed and __sap_hana_install_fact_is_main_host) or
        ('sap_hana_install_hdblcm_commandline' in ansible_run_tags | d([]))
      tags: sap_hana_install_hdblcm_commandline

    - name: SAP HANA - Install - Post-tasks
      ansible.builtin.include_tasks:
        file: post_install.yml


- name: Block for Addhosts tasks
  when: >
    not sap_hana_install_new_system and
    ((__sap_hana_install_fact_is_scaleout and __sap_hana_install_fact_is_installed) or
    ('sap_hana_install_hdblcm_commandline' in ansible_run_tags | d([])) or
    ('sap_hana_install_create_configfile' in ansible_run_tags | d([])))
  block:
    # Execute only if new hosts are to be added.
    - name: SAP HANA - Addhosts - Pre-Tasks
      ansible.builtin.include_tasks:
        file: pre_addhosts.yml
      when: >
        (__sap_hana_install_fact_addhosts_hosts_new | d([]) | length > 0) or
        ('sap_hana_install_hdblcm_commandline' in ansible_run_tags | d([])) or
        ('sap_hana_install_create_configfile' in ansible_run_tags | d([]))
      tags:
        - sap_hana_install_hdblcm_commandline
        - sap_hana_install_create_configfile

    - name: SAP HANA - Addhosts
      ansible.builtin.include_tasks:
        file: hana_addhosts.yml
      when:
        (__sap_hana_install_fact_addhosts_hosts_new | d([]) | length > 0 and __sap_hana_install_fact_is_main_host) or
        ('sap_hana_install_hdblcm_commandline' in ansible_run_tags | d([])) or
        ('sap_hana_install_create_configfile' in ansible_run_tags | d([]))
      tags:
        - sap_hana_install_hdblcm_commandline
        - sap_hana_install_create_configfile

    - name: SAP HANA - Addhosts - Post-tasks
      ansible.builtin.include_tasks:
        file: post_addhosts.yml


# Show final status of SAP HANA System
# Gather details about installed database for finished message
- name: SAP HANA - Main - Run 'hdblcm --list_systems' after the completion
  ansible.builtin.shell: |
      set -o pipefail && ./hdblcm --list_systems | awk '/\/hana\/shared\/{{ sap_hana_install_sid }}/{a=1}
      /version:/{if (a==1){
        gsub ("^\\s*version: ", "");printf ("%s;", $NF)}
      }
      /hosts?:/{if (a==1){
        gsub ("^\\s*hosts?: ", ""); gsub (", ", ","); print; a=0}
      }'
  args:
    chdir: "{{ sap_hana_install_shared_path }}/{{ sap_hana_install_sid }}/hdblcm"
  register: __sap_hana_install_register_completion_result
  changed_when: false
  when:
    - not ansible_check_mode
    - __sap_hana_install_fact_is_main_host

- name: SAP HANA - Main - Display SAP HANA details and completed post tasks
  ansible.builtin.debug:
    msg: |
      SAP HANA database is installed and running:
      HANA Version     -       {{ __sap_hana_install_fact_hana_version }}
      Hosts            -       {{ __sap_hana_install_fact_hana_hosts }}
      SID              -       {{ sap_hana_install_sid }}
      NR               -       {{ sap_hana_install_number }}

      {% if sap_hana_install_new_system and __sap_hana_install_fact_is_installed and __sap_hana_install_fact_addhosts_hosts_new | length > 0 %}
      The new hosts defined in the variable 'sap_hana_install_addhosts' were not added: {{ __sap_hana_install_fact_addhosts_hosts_new | join(', ') }}.
      Execute this role with the variable 'sap_hana_install_new_system' set to false to add new hosts.
      {% endif %}

      {% if sap_hana_install_update_firewall %}
      Firewall is enabled and SAP HANA ports are open.
      {% endif %}
      {% if __sap_hana_install_configure_selinux %}
      SELinux file contexts are configured for SAP folders ({{ sap_hana_install_directories | map('quote') | join(', ') }}).
      {% endif %}
      {% if ansible_os_family == "RedHat" and __sap_hana_install_configure_fapolicyd %}
      Fapolicyd is configured for SAP folders ({{ sap_hana_install_directories | map('quote') | join(', ') }}).
      {% endif %}
  vars:
    __sap_hana_install_fact_hana_version: "{{ __sap_hana_install_register_completion_result.stdout.split(';')[0] }}"
    __sap_hana_install_fact_hana_hosts: "{{ __sap_hana_install_register_completion_result.stdout.split(';')[1] }}"
  when:
    - not ansible_check_mode
    - __sap_hana_install_fact_is_main_host
