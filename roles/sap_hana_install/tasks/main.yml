# SPDX-License-Identifier: Apache-2.0
---

# Load variables while maintaining backwards compatibility when variable is empty string.
# Check if variable is defined and non-empty before using it, otherwise fall back to backwards
# compatible variable or default empty string that will fail asserts afterwards.
# NOTE: This is not __var assignment so it will not override user specified vars due to precedence!
- name: Rename some variables used by hdblcm configfile
  ansible.builtin.set_fact:
    sap_hana_install_sid:
      "{{ sap_hana_sid | d('')
        if sap_hana_install_sid | string | length == 0
        else sap_hana_install_sid }}"
    sap_hana_install_number:
      "{{ sap_hana_instance_number | d(sap_hana_install_instance_nr) | d(sap_hana_install_instance_number) | d('')
        if sap_hana_install_number | string | length == 0
        else sap_hana_install_number }}"
    sap_hana_install_system_usage: "{{ sap_hana_install_env_type | d(sap_hana_install_system_usage) | d('custom') }}"
    sap_hana_install_restrict_max_mem: "{{ sap_hana_install_mem_restrict | d(sap_hana_install_restrict_max_mem) | d('n') }}"
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_check_installation
    - sap_hana_install_preinstall
    - sap_hana_install_set_log_mode
    - sap_hana_install_configure_firewall

# Separate task for password with no_log
- name: Rename some variables used by hdblcm configfile - passwords
  ansible.builtin.set_fact:
    sap_hana_install_master_password:
      "{{ sap_hana_install_common_master_password | d('')
        if sap_hana_install_master_password is not defined or sap_hana_install_master_password | string | length == 0
        else sap_hana_install_master_password }}"
  no_log: true  # Required for password handling
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_check_installation
    - sap_hana_install_preinstall
    - sap_hana_install_set_log_mode
    - sap_hana_install_configure_firewall

- name: Validate the role variables
  ansible.builtin.include_tasks:
    file: assert_variables.yml
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_check_installation
    - sap_hana_install_preinstall
    - sap_hana_install_set_log_mode
    - sap_hana_install_configure_firewall

# SELinux is not currently supported by SAP using SLES4SAP
# This can still be overwritten by extra variables.
- name: SAP HANA Pre Install - Ensure SELinux does not execute for SLES
  ansible.builtin.set_fact:
    sap_hana_install_modify_selinux_labels: false
  when: ansible_os_family == "Suse"


# SAP HANA presence has to be validated for both new system and adding new hosts.
- name: Validate presence of existing SAP HANA database
  ansible.builtin.include_tasks:
    file: hana_exists.yml
  when:
    - (sap_hana_install_new_system and not sap_hana_install_force)
      or not sap_hana_install_new_system
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_preinstall


- name: Ensure SAP HANA is running for existing systems or addhosts operations
  ansible.builtin.include_tasks:
    file: hana_start.yml
  when: __sap_hana_install_fact_is_installed | d(false)


# Instructions for separating tasks to achieve idempotency:
# - Installation - Run once for new installations, never repeated.
# - Configuration - Run always to ensure idempotent outcome.

# Pre-installation currently does not contain configuration tasks, which would require idempotency.
# Executed for new installations and addhosts, because addhosts configfile creation is included.
- name: SAP HANA pre-install steps
  ansible.builtin.include_tasks:
    file: pre_install.yml
  tags: sap_hana_install_preinstall
  when:
    - (sap_hana_install_new_system and not __sap_hana_install_fact_is_installed | d(false))
      or not sap_hana_install_new_system

# Installation currently does not contain configuration tasks, which would require idempotency.
# Executed only for new installations.
- name: SAP HANA installation steps
  ansible.builtin.include_tasks:
    file: hana_install.yml
  when:
    - not __sap_hana_install_fact_is_installed | d(false)
    - sap_hana_install_new_system

# Executed only for addhosts.
- name: SAP HANA addhosts steps
  ansible.builtin.include_tasks:
    file: hana_addhosts.yml
  when:
    - __sap_hana_install_fact_is_installed | d(false)
    - not sap_hana_install_new_system

# Post-installation contains both installation and configuration tasks.
# Executed for new or existing installations and addhosts.
- name: SAP HANA post-install steps
  ansible.builtin.include_tasks:
    file: post_install.yml
