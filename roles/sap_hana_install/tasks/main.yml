# SPDX-License-Identifier: Apache-2.0
---

# Load variables while maintaining backwards compatibility when variable is empty string.
# Check if variable is defined and non-empty before using it, otherwise fall back to backwards
# compatible variable or default empty string that will fail asserts afterwards.
# NOTE: This is not __var assignment so it will not override user specified vars due to precedence!
- name: Set mandatory variables used by hdblcm configfile
  ansible.builtin.set_fact:
    sap_hana_install_sid:
      "{{ sap_hana_sid | d('')
        if sap_hana_install_sid | string | length == 0
        else sap_hana_install_sid }}"
    sap_hana_install_number:
      "{{ sap_hana_instance_number | d(sap_hana_install_instance_nr) | d(sap_hana_install_instance_number) | d('')
        if sap_hana_install_number | string | length == 0
        else sap_hana_install_number }}"
    sap_hana_install_system_usage: "{{ sap_hana_install_env_type | d(sap_hana_install_system_usage) | d('custom') }}"
    sap_hana_install_restrict_max_mem: "{{ sap_hana_install_mem_restrict | d(sap_hana_install_restrict_max_mem) | d('n') }}"
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_check_installation
    - sap_hana_install_preinstall
    - sap_hana_install_set_log_mode
    - sap_hana_install_configure_firewall

# Separate task for password with no_log
- name: Set mandatory variables used by hdblcm configfile - passwords
  ansible.builtin.set_fact:
    sap_hana_install_master_password:
      "{{ sap_hana_install_common_master_password | d('')
        if sap_hana_install_master_password is not defined or sap_hana_install_master_password | string | length == 0
        else sap_hana_install_master_password }}"
  no_log: true  # Required for password handling
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_check_installation
    - sap_hana_install_preinstall
    - sap_hana_install_set_log_mode
    - sap_hana_install_configure_firewall

- name: Validate the role variables
  ansible.builtin.include_tasks:
    file: pre_tasks/assert_variables.yml
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_check_installation
    - sap_hana_install_preinstall
    - sap_hana_install_set_log_mode
    - sap_hana_install_configure_firewall

# SELinux is not currently supported by SAP using SLES4SAP
# This can still be overwritten by extra variables.
- name: SAP HANA Pre Install - Ensure SELinux does not execute for SLES
  ansible.builtin.set_fact:
    sap_hana_install_modify_selinux_labels: false
  when: ansible_os_family == "Suse"


# SAP HANA presence has to be validated for both new system and adding new hosts.
- name: Validate presence of existing SAP HANA database
  ansible.builtin.include_tasks:
    file: pre_tasks/hana_exists.yml
  when:
    - (sap_hana_install_new_system and not sap_hana_install_force)
      or not sap_hana_install_new_system
  tags:
    - sap_hana_install_check_hana_exists
    - sap_hana_install_preinstall


- name: Ensure SAP HANA is running for existing systems or addhosts operations
  ansible.builtin.include_tasks:
    file: pre_tasks/hana_start.yml
  when: __sap_hana_install_fact_is_installed


- name: Validate connection to provided addhosts
  ansible.builtin.include_tasks:
    file: pre_tasks/check_addhosts.yml
  when:
    - sap_hana_install_addhosts is defined
    - sap_hana_install_addhosts is string
    - sap_hana_install_addhosts | trim | length > 0

# The list is used for all configuration tasks.
# Ensures that current managed node is included for all configuration tasks.
- name: Set fact with list of all hostnames
  ansible.builtin.set_fact:
    __sap_hana_install_fact_all_hosts:
      "{{ __sap_hana_install_fact_addhosts_hosts | d([]) + [inventory_hostname_short | d('')] | unique }}"


# Instructions for separating tasks to achieve idempotency:
# - Installation - Run once for new installations, never repeated.
# - Configuration - Run always to ensure idempotent outcome.

- name: Block for Installation tasks
  when: sap_hana_install_new_system
  block:
    - name: SAP HANA - Install - Pre-Tasks
      ansible.builtin.include_tasks:
        file: pre_install.yml
      tags: sap_hana_install_preinstall
      when: not __sap_hana_install_fact_is_installed

    - name: SAP HANA - Install
      ansible.builtin.include_tasks:
        file: hana_install.yml
      when:
        - not __sap_hana_install_fact_is_installed

    - name: SAP HANA - Install - Post-tasks
      ansible.builtin.include_tasks:
        file: post_install.yml


# hana_exists already fails if HANA is not detected.
- name: Block for Addhosts tasks
  when:
    - not sap_hana_install_new_system
    - __sap_hana_install_fact_is_installed
  block:
    # Execute only if new hosts are to be added.
    - name: SAP HANA - Addhosts - Pre-Tasks
      ansible.builtin.include_tasks:
        file: pre_addhosts.yml
      when: __sap_hana_install_fact_addhosts_hosts_new | d([]) | length > 0
      tags: sap_hana_install_preinstall

    - name: SAP HANA - Addhosts
      ansible.builtin.include_tasks:
        file: hana_addhosts.yml
      when: __sap_hana_install_fact_addhosts_hosts_new | d([]) | length > 0

    - name: SAP HANA - Addhosts - Post-tasks
      ansible.builtin.include_tasks:
        file: post_addhosts.yml


# Show final status of SAP HANA System
# Gather details about installed database for finished message
- name: SAP HANA - Run 'hdblcm --list_systems' after the completion
  ansible.builtin.shell: |
      set -o pipefail && ./hdblcm --list_systems | awk '/\/hana\/shared\/{{ sap_hana_install_sid }}/{a=1}
      /version:/{if (a==1){
        gsub ("^\\s*version: ", "");printf ("%s;", $NF)}
      }
      /hosts?:/{if (a==1){
        gsub ("^\\s*hosts?: ", ""); gsub (", ", ","); print; a=0}
      }'
  args:
    chdir: "{{ sap_hana_install_shared_path }}/{{ sap_hana_install_sid }}/hdblcm"
  register: __sap_hana_install_register_completion_result
  changed_when: false
  when: not ansible_check_mode

- name: SAP HANA - Display SAP HANA details and completed post tasks
  ansible.builtin.debug:
    msg: |
      SAP HANA database is installed and running:
      HANA Version     -       {{ __sap_hana_install_fact_hana_version }}
      Hosts            -       {{ __sap_hana_install_fact_hana_hosts }}
      SID              -       {{ sap_hana_install_sid }}
      NR               -       {{ sap_hana_install_number }}

      {% if sap_hana_install_new_system and __sap_hana_install_fact_is_installed and __sap_hana_install_fact_addhosts_hosts_new | length > 0 %}
      The new hosts defined in the variable 'sap_hana_install_addhosts' were not added: {{ __sap_hana_install_fact_addhosts_hosts_new | join(', ') }}.
      Execute this role with the variable 'sap_hana_install_new_system' set to false to add new hosts.
      {% endif %}

      {% if sap_hana_install_update_firewall %}
      Firewall is enabled and SAP HANA ports are open.
      {% endif %}
      {% if sap_hana_install_modify_selinux_labels %}
      SELinux file contexts are configured for SAP folders '{{ sap_hana_install_root_path }}' and '/usr/sap'.
      {% endif %}
      {% if ansible_os_family == "RedHat" and sap_hana_install_use_fapolicyd %}
      Fapolicyd is configured for SAP folders '{{ sap_hana_install_root_path }}' and '/usr/sap'.
      {% endif %}
  vars:
    __sap_hana_install_fact_hana_version: "{{ __sap_hana_install_register_completion_result.stdout.split(';')[0] }}"
    __sap_hana_install_fact_hana_hosts: "{{ __sap_hana_install_register_completion_result.stdout.split(';')[1] }}"
  when:
    - not ansible_check_mode
