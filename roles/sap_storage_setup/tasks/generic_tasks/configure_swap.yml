# SPDX-License-Identifier: Apache-2.0
---

# Starting with SLES 16, the default filesystem is 'btrfs' which requires special handling when creating a swap file.
# Swapon on btrfs filesystems will fail with "swapon: /swapfile: swapon failed: Invalid argument"
# This is solved by setting the NOCOW attribute on the swap file with 'chattr +C /swapfile'.
# Fallocate command does not always create empty file, resulting in 'chattr +C' silently failing.
# Therefore, we first create an empty file with 'touch'.

- name: SAP Storage Setup - Block handling the swap file
  # Block parameters
  vars:
    # Select the swap_file entry from the storage definition
    # and convert the single element list to a dict
    swap_file: |
      {{- sap_storage_setup_definition
      | selectattr("filesystem_type", "defined")
      | selectattr("filesystem_type", "==", "swap")
      | selectattr("swap_path", "defined")
      | first
      -}}

  # Block conditional
  when: |
    sap_storage_setup_definition
    | selectattr("swap_path", "defined")
    | selectattr("filesystem_type", "defined")
    | selectattr("filesystem_type", "==", "swap")
    | length > 0

  block:

    - name: SAP Storage Setup - (swap file) Check if file exists
      ansible.builtin.stat:
        path: "{{ swap_file.swap_path }}"
      register: __sap_storage_setup_register_check_swapfile

    - name: SAP Storage Setup - (swap file) Get all active swap files and partitions
      ansible.builtin.command:
        cmd: "swapon --show=NAME --noheadings"
      register: __sap_storage_setup_register_swapfile_active
      changed_when: false


    - name: SAP Storage Setup - (swap file) Create empty file for swap with touch
      ansible.builtin.file:
        path: "{{ swap_file.swap_path }}"
        state: touch
        mode: '0600'
      when:
        - not __sap_storage_setup_register_check_swapfile.stat.exists

    - name: SAP Storage Setup - (swap file) Get the actual mount point and filesystem type
      # This command returns just the fstype of the mount containing the path
      ansible.builtin.shell:
        cmd: "set -o pipefail && df --output=fstype {{ swap_file.swap_path | dirname }} | tail -1"
      register: __sap_storage_setup_register_swapfile_fstype
      changed_when: false


    - name: Block for btrfs handling
      when: __sap_storage_setup_register_swapfile_fstype.stdout | trim == 'btrfs'
      block:
        - name: SAP Storage Setup - (swap file) - btrfs - Check file attributes
          ansible.builtin.command:
            cmd: "lsattr {{ swap_file.swap_path }}"
          register: __sap_storage_setup_register_swapfile_attributes
          failed_when: false
          changed_when: false

        - name: SAP Storage Setup - (swap file) - btrfs - Fail when swap file exists without NOCOW attribute
          ansible.builtin.fail:
            msg: |
              FAIL: The swap file {{ swap_file.swap_path }} exists on a btrfs filesystem but does not have the NOCOW attribute set.
              This will lead to failure when activating the swap file.
              Please remove the existing swap file and rerun this Ansible Role to re-create swap file with correct attributes.
          when:
            - __sap_storage_setup_register_check_swapfile.stat.exists
            - __sap_storage_setup_register_swapfile_attributes.rc is defined
            - __sap_storage_setup_register_swapfile_attributes.rc == 0
            - "'C' not in __sap_storage_setup_register_swapfile_attributes.stdout"

        - name: SAP Storage Setup - (swap file) - btrfs - Create 0-byte file and set NOCOW
          ansible.builtin.file:
            path: "{{ swap_file.swap_path }}"
            attributes: '+C'
          when:
            - not __sap_storage_setup_register_check_swapfile.stat.exists
            - "'C' not in __sap_storage_setup_register_swapfile_attributes.stdout"


    - name: SAP Storage Setup - (swap file) Allocate space
      ansible.builtin.command:
        cmd: "fallocate -l {{ swap_file.disk_size | int * 1024 }}MB {{ swap_file.swap_path }}"
      changed_when: true
      when:
        - not __sap_storage_setup_register_check_swapfile.stat.exists

    - name: SAP Storage Setup - (swap file) Adjust file permissions
      ansible.builtin.file:
        path: "{{ swap_file.swap_path }}"
        mode: "0600"

    # We will format swap file only when newly created to avoid touching existing.
    - name: SAP Storage Setup - (swap file) Format the new swap file
      ansible.builtin.command:
        cmd: "mkswap {{ swap_file.swap_path }}"
      changed_when: true
      when:
        - not __sap_storage_setup_register_check_swapfile.stat.exists

    # Fstab will be always updated even if already existing.
    # 'path' must be 'none' or 'swap' for swap devices.
    # 'opts' should contain 'sw' for swap devices.
    - name: SAP Storage Setup - (swap file) Maintain entry in /etc/fstab
      ansible.posix.mount:
        path: none
        src: "{{ swap_file.swap_path }}"
        fstype: swap
        opts: sw
        state: present

    # Activate swap file if it is not already active.
    - name: SAP Storage Setup - (swap file) Activate swap file
      ansible.builtin.command:
        cmd: "swapon {{ swap_file.swap_path }}"
      register: __sap_storage_setup_register_swapfile_activate
      changed_when: true
      failed_when: false
      when:
        - swap_file.swap_path not in __sap_storage_setup_register_swapfile_active.stdout_lines

    - name: SAP Storage Setup - (swap file) Fail if swap file could not be activated
      ansible.builtin.fail:
        msg: |
          FAIL: The swap file {{ swap_file.swap_path }} could not be activated.
          {% if __sap_storage_setup_register_check_swapfile.stat.exists %}
          The existing swap file might be corrupted or was not created with correct attributes.
          {% else %}
          The newly created swap file could not be activated. Please check the system logs for details.
          {% endif %}

          Command output: {{ __sap_storage_setup_register_swapfile_activate.stdout }}
      when:
        - __sap_storage_setup_register_swapfile_activate.rc is defined
        - __sap_storage_setup_register_swapfile_activate.rc != 0


### End of swapfile block

- name: SAP Storage Setup - Block handling a swap partition filesystem
  # Block parameters
  vars:
    # Select the swap volume entry from the storage definition
    # and convert the single element list to a dict.
    # Difference to swapfile logic is the absence of the "swap_path" parameter in that entry.
    swap_volume: |
      {{- sap_storage_setup_definition
      | selectattr("filesystem_type", "defined")
      | selectattr("filesystem_type", "==", "swap")
      | selectattr("swap_path", "undefined")
      | first
      -}}

    # Define the full path to the swap partition for easier reference in subsequent tasks.
    swap_partition_path:
      "/dev/{{ swap_volume.lvm_vg_name | default('vg_swap') }}/{{ swap_volume.lvm_lv_name | default('lv_swap') }}"

  # Block conditional
  when: |
    sap_storage_setup_definition
    | selectattr("swap_path", "undefined")
    | selectattr("filesystem_type", "defined")
    | selectattr("filesystem_type", "==", "swap")
    | length > 0

  block:

    # TODO: This can be replaced with "swapon --show=NAME --noheadings" if applicable.
    - name: SAP Storage Setup - (swap partition) Get all existing swap partitions
      ansible.builtin.shell: |
        set -o pipefail && lsblk | grep SWAP || echo "no active swap"
      register: __sap_storage_setup_register_check_swap_partition
      changed_when: false

    - name: SAP Storage Setup - (swap partition) Check if LV device exists
      ansible.builtin.stat:
        path: "{{ swap_partition_path }}"
      register: __sap_storage_setup_register_check_swap_partition_stat

    - name: SAP Storage Setup - (swap partition) Fail if LV device does not exist
      ansible.builtin.fail:
        msg: |
          FAIL: The logical volume device '{{ swap_partition_path }}' for the swap partition was not found.
          This indicates that the LVM creation tasks may have failed. Please check the logs for earlier errors.
      when:
        - not __sap_storage_setup_register_check_swap_partition_stat.stat.exists
        - not ansible_check_mode

    - name: SAP Storage Setup - (swap partition) Maintain entry in /etc/fstab
      ansible.posix.mount:
        path: swap
        src: "{{ swap_partition_path }}"
        fstype: swap
        opts: defaults
        state: present

    - name: SAP Storage Setup - (swap partition) Enable swap
      ansible.builtin.command: |
        swapon {{ swap_partition_path }}
      changed_when: true
      when:
        - not ansible_check_mode
        - swap_volume.lvm_lv_name | default("lv_swap") not in __sap_storage_setup_register_check_swap_partition.stdout

### End of block: swap filesystem
