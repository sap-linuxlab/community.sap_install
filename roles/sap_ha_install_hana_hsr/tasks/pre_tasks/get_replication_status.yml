# SPDX-License-Identifier: Apache-2.0
---

- name: SAP HSR - Check System Replication Status
  ansible.builtin.shell:
    cmd: >-
      source {{ __sap_ha_install_hana_hsr_home_path }}/.profile &&
      {{ sap_ha_install_hana_hsr_executable_path }}/hdbnsutil
      -sr_state
  become: true
  become_user: "{{ __sap_ha_install_hana_hsr_sid | lower }}adm"
  register: __sap_ha_install_hana_hsr_register_srstate
  changed_when: false
  failed_when: false

- name: SAP HSR - Set fact if replication is enabled
  ansible.builtin.set_fact:
    __sap_ha_install_hana_hsr_fact_replication_enabled: true
  when: >
    ( __sap_ha_install_hana_hsr_fact_is_primary and
      'is source system: true' in __sap_ha_install_hana_hsr_register_srstate.stdout ) or
    ( __sap_ha_install_hana_hsr_fact_is_secondary and
      ( 'is secondary system: true' in __sap_ha_install_hana_hsr_register_srstate.stdout or
        'is secondary/consumer system: true' in __sap_ha_install_hana_hsr_register_srstate.stdout ) )

- name: SAP HSR - Inform if existing System Replication was found
  ansible.builtin.debug:
    msg: Existing System Replication was found on this node.
  when: __sap_ha_install_hana_hsr_fact_replication_enabled
