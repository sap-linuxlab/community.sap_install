# SPDX-License-Identifier: Apache-2.0
---

- name: SAP HSR - Check presence of hdbuserstore executable
  ansible.builtin.stat:
    path: "/usr/sap/{{ __sap_ha_install_hana_hsr_sid }}/SYS/exe/hdb/hdbuserstore"
  register: __sap_ha_install_hana_hsr_register_stat_hdbuserstore

- name: SAP HSR - Assert that hdbuserstore executable exists
  ansible.builtin.assert:
    that:
      - __sap_ha_install_hana_hsr_register_stat_hdbuserstore.stat.exists
    fail_msg: |
      FAIL: The hdbuserstore executable does not exist at
      /usr/sap/{{ __sap_ha_install_hana_hsr_sid }}/SYS/exe/hdb/hdbuserstore.

# ansible-lint:
# become_user string is deduced from a variable + suffix with no spaces
- name: SAP HSR - Check if hdbuserstore exists
  become: true
  become_user: "{{ __sap_ha_install_hana_hsr_sid | lower }}adm"
  ansible.builtin.command:
    cmd: >-
      /usr/sap/{{ __sap_ha_install_hana_hsr_sid }}/SYS/exe/hdb/hdbuserstore
      List {{ sap_ha_install_hana_hsr_hdbuserstore_system_backup_user }}
  register: __sap_ha_install_hana_hsr_register_hdbuserstore_list
  failed_when: false
  changed_when: false

# CHECK, if ansible_facts['hostname'] needs to be replaced with interface name
# ansible-lint:
# become_user string is deduced from a variable + suffix with no spaces
- name: SAP HSR - Create and Store Connection Info in hdbuserstore
  become: true
  become_user: "{{ __sap_ha_install_hana_hsr_sid | lower }}adm"
  ansible.builtin.command:
    cmd: >-
      /usr/sap/{{ __sap_ha_install_hana_hsr_sid }}/SYS/exe/hdb/hdbuserstore
      SET {{ sap_ha_install_hana_hsr_hdbuserstore_system_backup_user }}
      {{ ansible_facts['hostname'] }}:3{{ __sap_ha_install_hana_hsr_instance_number }}13
      SYSTEM '{{ __sap_ha_install_hana_hsr_db_system_password }}'
  when: __sap_ha_install_hana_hsr_register_hdbuserstore_list.rc != '0'
  changed_when: true
