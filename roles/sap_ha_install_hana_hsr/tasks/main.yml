# SPDX-License-Identifier: Apache-2.0
---

- name: SAP HSR - Prepare and validate variables
  ansible.builtin.include_tasks:
    file: pre_tasks/prepare_variables.yml
    apply:
      tags: always
  tags: always

# All replication tasks should be executed on running HANA instances.
# sr_enable - primary must be running.
# sr_register - secondary can be running because of --online option.
# sr_unregister - secondary should be running to avoid warnings.
# sr_disable - primary must be running.
- name: SAP HSR - Ensure that SAP HANA is started
  ansible.builtin.include_tasks:
    file: pre_tasks/start_hana.yml
    apply:
      tags: always
  tags: always

- name: SAP HSR - Get current state of replication
  ansible.builtin.include_tasks:
    file: pre_tasks/get_replication_status.yml
    apply:
      tags: always
  tags: always

- name: SAP HSR - Test connection to primary node
  ansible.builtin.include_tasks:
    file: pre_tasks/test_connection.yml
    apply:
      tags: hsr_pki
  when:
    - not __sap_ha_install_hana_hsr_fact_replication_enabled
    - __sap_ha_install_hana_hsr_fact_is_secondary
  tags: hsr_pki


- name: Block for pre-tasks for enabling HSR
  when:
    - sap_ha_install_hana_hsr_state | d('present') == 'present'
    - not __sap_ha_install_hana_hsr_fact_replication_enabled
  block:

    - name: SAP HSR - Update /etc/hosts
      ansible.builtin.include_tasks:
        file: pre_tasks/update_etchosts.yml
        apply:
          tags: hsr_etchosts
      when:
        - sap_ha_install_hana_hsr_update_etchosts or
          (sap_hana_update_etchosts is defined and sap_hana_update_etchosts)
      tags:
        - hsr_etchosts

    # TODO: Add steps to open firewall ports 3XX00 - 3XX99 using LSR Firewall role.
    # This will be added in sap_ha_pacemaker_cluster role as well so there could be overlap.

    - name: SAP HSR - Configure hdbuserstore
      ansible.builtin.include_tasks:
        file: pre_tasks/configure_hdbuserstore.yml
        apply:
          tags: hsr_hdbuserstore
      tags:
        - hsr_hdbuserstore

    - name: SAP HSR - Set default log mode
      ansible.builtin.include_tasks:
        file: pre_tasks/set_log_mode.yml
        apply:
          tags: hsr_logmode
      tags:
        - hsr_logmode

    - name: SAP HSR - Prepare and sync PKI Files
      ansible.builtin.include_tasks:
        file: pre_tasks/sync_pki_files.yml
        apply:
          tags: hsr_pki
          vars:
            __sap_ha_install_hana_hsr_secpath: "/usr/sap/{{ __sap_ha_install_hana_hsr_sid }}/SYS/global/security/rsecssfs"
      when: __sap_ha_install_hana_hsr_fact_is_secondary
      tags:
        - hsr_pki

    - name: SAP HSR - Run Backup before configuring replication
      ansible.builtin.include_tasks:
        file: pre_tasks/create_backup.yml
        apply:
          become: true
          become_user: "{{ __sap_ha_install_hana_hsr_sid | lower }}adm"
          tags: hsr_backup
      when:
        - __sap_ha_install_hana_hsr_fact_is_primary
        - sap_ha_install_hana_hsr_create_backup | d(true)| bool
      tags:
        - hsr_backup


- name: SAP HSR - Ensure HSR is configured
  ansible.builtin.include_tasks:
    file: enable_hsr.yml
    apply:
      tags: hsr_enable
  tags:
    - hsr_enable
  when:
    - sap_ha_install_hana_hsr_state | d('present') == 'present'
    - not __sap_ha_install_hana_hsr_fact_replication_enabled

- name: SAP HSR - Ensure HSR is removed
  ansible.builtin.include_tasks:
    file: disable_hsr.yml
    apply:
      tags: hsr_disable
  tags:
    - hsr_disable
  when:
    - sap_ha_install_hana_hsr_state | d('present') == 'absent'
    - __sap_ha_install_hana_hsr_fact_replication_enabled


- name: SAP HSR - Show final message and current replication status
  ansible.builtin.debug:
    msg: |
      {% if sap_ha_install_hana_hsr_state | d('present') == 'present' %}
      HANA System Replication is enabled on this node.
      {% else %}
      HANA System Replication is disabled on this node.
      {% endif %}

      Current System Replication status:
      {{ __sap_ha_install_hana_hsr_register_srstate_after.stdout | d(__sap_ha_install_hana_hsr_register_srstate.stdout) }}
