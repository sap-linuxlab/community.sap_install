# SPDX-License-Identifier: Apache-2.0
---

# Custom STONITH can be used for customizing but also debugging.
# This task file must ensure that empty list is allowed.

# Show warning and disable fencing if user STONITH resources are not defined.
- name: Block when STONITH list is defined but empty
  when: sap_ha_pacemaker_cluster_stonith_custom | length == 0
  block:

    # Ensure that property 'stonith-enabled' is set to 'false' if no Stonith resources are defined.
    # STONITH property will be disabled only if 'sap_ha_pacemaker_cluster_cluster_properties' is not defined.
    - name: "SAP HA Prepare Pacemaker - (STONITH) Set to disabled when no fencing resource is defined"
      when:
        - ha_cluster_cluster_properties is not defined  # We cannot append to defined variable due to precedence.
        - sap_ha_pacemaker_cluster_cluster_properties is not defined
      ansible.builtin.set_fact:
        __sap_ha_pacemaker_cluster_cluster_properties:
          "{{ __sap_ha_pacemaker_cluster_cluster_properties | combine({'stonith-enabled': false}) }}"

    - name: "SAP HA Prepare Pacemaker - Warning when no STONITH resources are defined"
      ansible.builtin.pause:
        seconds: 5
        prompt: |
          WARNING: The variable 'sap_ha_pacemaker_cluster_stonith_custom' is defined, but empty!
          {% if ha_cluster_cluster_properties is not defined and sap_ha_pacemaker_cluster_cluster_properties is not defined %}
          No STONITH resources are defined and STONITH will be disabled!
          The cluster property "stonith-enabled: false" will be configured to disable fencing.
          {% else %}
          No STONITH resources are defined!
          {% endif %}

          Please configure appropriate fencing resources for your environment by following steps:
          - Add a STONITH resource(s) using the variable 'sap_ha_pacemaker_cluster_stonith_custom'.
          - Add a cluster property "stonith-enabled: true" to 'sap_ha_pacemaker_cluster_cluster_properties'.


- name: "SAP HA Prepare Pacemaker - Warning when pcmk_delay_max is missing"
  when:
    - sap_ha_pacemaker_cluster_stonith_custom | length > 0
    - sap_ha_pacemaker_cluster_stonith_custom | map(attribute='instance_attrs', default=[]) | flatten
        | map(attribute='attrs', default=[]) | flatten | selectattr('name', 'equalto', 'pcmk_delay_max') | length == 0
  ansible.builtin.debug:
    msg: |
      WARNING: The STONITH resource is missing 'pcmk_delay_max'!

      Without a delay, both cluster nodes may attempt to fence each other simultaneously
      during a split-brain event ("Double STONITH"), leading to a total cluster outage.
      Add pcmk_delay_max=15 (or similar) to STONITH resource defined in the variable 'sap_ha_pacemaker_cluster_stonith_custom'.


# Prepare structure compatible with the variable 'ha_cluster_cluster_properties'.
- name: "SAP HA Prepare Pacemaker - (STONITH) Define cluster properties"
  when:
    - ha_cluster_cluster_properties is not defined  # We cannot append to defined variable due to precedence.
    - sap_ha_pacemaker_cluster_cluster_properties is defined
  ansible.builtin.set_fact:
    __sap_ha_pacemaker_cluster_cluster_properties:
      - attrs: |-
          {% set attrs = [] -%}
          {%- for default_cluster_properties in (__sap_ha_pacemaker_cluster_cluster_properties | dict2items) -%}
            {% set role_attrs = attrs.extend([
              {
                'name': default_cluster_properties.key,
                'value': default_cluster_properties.value
              }
            ]) -%}
          {%- endfor %}
          {{ attrs }}


# SBD Configuration is executed only when all conditions are met:
# sap_ha_pacemaker_cluster_sbd_enabled is true
# sap_ha_pacemaker_cluster_sbd_devices is defined, list and not empty
# sap_ha_pacemaker_cluster_stonith_custom is defined, list and not empty
# __sap_ha_pacemaker_cluster_sbd_enabled is not defined
- name: "SAP HA Prepare Pacemaker - (STONITH SBD) Prepare SBD configuration"
  when:
    - ha_cluster_sbd_enabled is not defined or ha_cluster_sbd_enabled | bool  # We cannot overwrite due to precedence.
    - sap_ha_pacemaker_cluster_sbd_enabled | d(false)
    - sap_ha_pacemaker_cluster_sbd_devices | d([]) | length > 0
    - sap_ha_pacemaker_cluster_stonith_custom | length > 0
  block:
    - name: "SAP HA Prepare Pacemaker - (STONITH SBD) Create sbd_options"
      when:
        - ha_cluster_sbd_options is not defined
      ansible.builtin.set_fact:
        __sap_ha_pacemaker_cluster_sbd_options: >-
          {%- if sap_ha_pacemaker_cluster_sbd_options | d([]) | length > 0 -%}
            {{ sap_ha_pacemaker_cluster_sbd_options }}
          {%- else -%}
            {{ [{'name': 'startmode', 'value': __sbd_startmode}] }}
          {%- endif -%}
      vars:
        __sbd_startmode: "{{ 'clean' if sap_ha_pacemaker_cluster_host_type | select('search', 'hana') | length > 0 else 'always' }}"


    # Create dictionary with SBD specific parameters for ha_cluster
    # Omit parameters if they are already present in provided dictionary sap_ha_pacemaker_cluster_ha_cluster
    - name: "SAP HA Prepare Pacemaker - (STONITH SBD) Create ha_cluster parameters for SBD"
      ansible.builtin.set_fact:
        __sap_ha_pacemaker_cluster_ha_cluster_stonith: >-
          {{
            dict(
              sbd_devices=(sap_ha_pacemaker_cluster_sbd_devices
                if sap_ha_pacemaker_cluster_sbd_devices | d([]) | length > 0 and not __ha_cluster_sbd_devices_exists
                else omit),
              sbd_watchdog=(sap_ha_pacemaker_cluster_sbd_watchdog
                if sap_ha_pacemaker_cluster_sbd_watchdog | d([]) | length > 0 and not __ha_cluster_sbd_watchdog_exists
                else omit),
              sbd_watchdog_modules=(sap_ha_pacemaker_cluster_sbd_watchdog_modules
                if sap_ha_pacemaker_cluster_sbd_watchdog_modules | d([]) | length > 0 and not __ha_cluster_sbd_watchdog_modules_exists
                else omit)
            )
          }}
      vars:
        # Detect if parameters were already provided in sap_ha_pacemaker_cluster_ha_cluster
        __ha_cluster_sbd_devices_exists:
          "{{ true if __sap_ha_pacemaker_cluster_ha_cluster.sbd_devices | d([]) | length > 0 else false }}"
        __ha_cluster_sbd_watchdog_exists:
          "{{ true if __sap_ha_pacemaker_cluster_ha_cluster.sbd_watchdog | d([]) | length > 0 else false }}"
        __ha_cluster_sbd_watchdog_modules_exists:
          "{{ true if __sap_ha_pacemaker_cluster_ha_cluster.sbd_watchdog_modules | d([]) | length > 0 else false }}"


    - name: "SAP HA Prepare Pacemaker - (STONITH SBD) Include sbd fence agent"
      ansible.builtin.set_fact:
        __sap_ha_pacemaker_cluster_fence_agent_packages:
          "{{ __sap_ha_pacemaker_cluster_fence_agent_packages + ['sbd'] }}"

    - name: "SAP HA Prepare Pacemaker - (STONITH SBD) Set __sap_ha_pacemaker_cluster_sbd_enabled"
      ansible.builtin.set_fact:
        __sap_ha_pacemaker_cluster_sbd_enabled: true


- name: "SAP HA Prepare Pacemaker - (STONITH) Assemble the resources from custom definition"
  when:
    - sap_ha_pacemaker_cluster_stonith_custom | length > 0
    - stonith_item.id | d('') | length > 0
    - stonith_item.id not in (__sap_ha_pacemaker_cluster_stonith_resource | d([]) | map(attribute='id'))
  ansible.builtin.set_fact:
    __sap_ha_pacemaker_cluster_stonith_resource:
      "{{ __sap_ha_pacemaker_cluster_stonith_resource | d([]) + [stonith_item] }}"
  loop: "{{ sap_ha_pacemaker_cluster_stonith_custom }}"
  loop_control:
    label: "{{ stonith_item.id }}"
    loop_var: stonith_item


# The STONITH resource is an element in the cluster_resource_primitives list
- name: "SAP HA Prepare Pacemaker - (STONITH) Construct resources definition"
  when:
    - __sap_ha_pacemaker_cluster_stonith_resource is defined
  ansible.builtin.set_fact:
    __sap_ha_pacemaker_cluster_resource_primitives:
      "{{ __sap_ha_pacemaker_cluster_resource_primitives
        + (__sap_ha_pacemaker_cluster_stonith_resource | from_yaml) }}"
  no_log: true  # stonith resources can contain secrets
